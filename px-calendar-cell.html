<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-range-behavior.html"/>

<script src="../moment/moment.js"></script>

<!--
Element that renders a calendar cell for a given date (and for non-date cells in the calendar).

##### Usage

    <px-calendar-cell display-date="{{...}}"
                      first-range-date="{{...}}"
                      second-range-date="{{...}}">
    </px-calendar-cell>

-->
<dom-module id="px-calendar-cell">
  <link rel="import" type="css" href="css/px-calendar.css"/>
  <template>
    <div class$="{{cellStyles}}">
      <button class$="{{btnStyles}}" value="{{displayedValue}}" on-tap="_selectDate" disabled="{{isDisabled}}" hidden$="{{!isValidDate}}">{{displayedValue}}</button>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-calendar-cell',
    behaviors: [pxDatetimeRangeBehavior],

    properties: {

      /**
       * Moment object with date to display in this cell
       */
      displayDate: Object,
      /**
       *  What the calendar should display:
       *  'day': day number
       *  'month': month
       *  'year': year
       *
       *  @default 'day'
       */
      displayMode: {
        type: String,
        value: 'day'
      }
    },

    observers: [
      '_updateDate(displayDate, firstRangeDate, secondRangeDate, displayMode)'
    ],

    ready: function() {
      this._updateDate(this.displayDate, this.firstRangeDate, this.secondRangeDate, this.displayMode, true);
    },
    /**
     *
     * Go through each cell and decide if it has a day in that month, is it selected, inbetween selected, etc.
     *
     */
    _updateDate: function(displayDate, firstRangeDate, secondRangeDate, displayMode, init) {

      if(this.displayMode === 'day') {
        this._displayDay(init);
      } else if(this.displayMode === 'month') {
        this._displayMonth();
      } else {
        this._displayYear();
      }

    },

    _displayDay: function(init) {
      var cellStyles = 'calendar-cell';
      var btnStyles = 'btn btn--bare';
      var isDisabled = false;

      this.set('isValidDate', this.displayDate.isValid());

      if (!this.isValidDate) {
        // if the cell is a blank cell of calendar (before/after start of month)
        cellStyles += ' is-empty';
        this.set('displayedValue', '');
      }
      else {
        this.set('displayedValue', this.displayDate.format('D'));

        if (!init && (this._isStartOfRange() || this._isEndOfRange())) {
          cellStyles += ' is-selected';
        }

        if (!init && this._isFirstClick()) {
          cellStyles += ' is-selected-only';
        }

        if (this._isStartOfWeekOrMonth() || (!init && this._isStartOfRange())) {
          cellStyles += ' is-start';
        }

        if (this._isEndOfWeekOrMonth() || (!init && this._isEndOfRange())) {
          cellStyles += ' is-end';
        }

        if (!init && this._isWithinRange()) {
          cellStyles += ' is-between';
        }

        if (this._isTodaysDate()) {
          cellStyles += ' is-today';
        }

        if (!this.allowFutureDates && this._isPastTodaysDate()) {
          btnStyles += ' btn--disabled';
          isDisabled = true;
        }
      }

      this.set('btnStyles', btnStyles);
      this.set('isDisabled', isDisabled);
      this.set('cellStyles', cellStyles);
    },


    _displayMonth: function() {
      var cellStyles = 'calendar-cell';
      var btnStyles = 'btn btn--bare btn--larger';
      var isDisabled = false;

      this.set('isValidDate', true);
      this.set('displayedValue', this.displayDate.format('MMM'));

      this.set('btnStyles', btnStyles);
      this.set('isDisabled', isDisabled);
      this.set('cellStyles', cellStyles);
    },


    _displayYear: function() {
      var cellStyles = 'calendar-cell';
      var btnStyles = 'btn btn--bare btn--larger';
      var isDisabled = false;

      this.set('isValidDate', true);
      this.set('displayedValue', this.displayDate.format('YYYY'));

      this.set('btnStyles', btnStyles);
      this.set('isDisabled', isDisabled);
      this.set('cellStyles', cellStyles);
    },

    _selectDate: function(e) {
      this.fire('px-date-selected', this.displayDate);
    },

    _isStartOfRange: function() {
      return this.displayDate.isSame(this._getStartDate(), 'day');
    },

    _isEndOfRange: function() {
      return this.displayDate.isSame(this._getEndDate(), 'day');
    },

    _isWithinRange: function() {
      return this.displayDate.isBetween(this._getStartDate(), this._getEndDate(), 'day');
    },

    _getStartDate: function() {
      var startDate = this.firstRangeDate;
      if (this.firstRangeDate.isAfter(this.secondRangeDate, 'day')) {
        startDate = this.secondRangeDate;
      }
      return startDate;
    },

    _getEndDate: function() {
      var endDate = this.secondRangeDate;
      if (this.firstRangeDate.isAfter(this.secondRangeDate, 'day')) {
        endDate = this.firstRangeDate;
      }
      return endDate;
    },

    _isFirstClick: function() {
      return this.secondRangeDate === null && this.displayDate.isSame(this.firstRangeDate, 'day');
    },

    _isStartOfWeekOrMonth: function() {
      return this.day == 1 || this.displayDate.weekday() == 0;
    },

    _isEndOfWeekOrMonth: function() {
      return this.day == this.displayDate.daysInMonth() || this.displayDate.weekday() == 6;
    },

    _isPastTodaysDate: function() {
      var todaysDate;
      if(this.isUtc) {
        todaysDate = moment.utc();
      }
      else {
        todaysDate = moment();
      }
      return this.displayDate.isAfter(todaysDate);
    },

    _isTodaysDate: function() {
      var todaysDate;
      if(this.isUtc) {
        todaysDate = moment.utc();
      }
      else {
        todaysDate = moment();
      }
      return this.displayDate.isSame(todaysDate, 'day');
    }
  });
</script>
